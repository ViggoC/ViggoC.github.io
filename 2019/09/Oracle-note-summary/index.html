<!DOCTYPE html>
<html lang="default">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://viggoc.github.io').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="安装  Oracle in Docker docke search oracle，选择相应的 image 拉取 123$ docker run -d --name oracle \  --privileged -v $(pwd)&#x2F;oradata:&#x2F;u01&#x2F;app&#x2F;oracle \  -p 8080:8080 -p 1521:1521 absolutapps">
<meta property="og:type" content="article">
<meta property="og:title" content="Oracle 笔记汇总">
<meta property="og:url" content="https://viggoc.github.io/2019/09/Oracle-note-summary/index.html">
<meta property="og:site_name" content="VC&#39; Blog">
<meta property="og:description" content="安装  Oracle in Docker docke search oracle，选择相应的 image 拉取 123$ docker run -d --name oracle \  --privileged -v $(pwd)&#x2F;oradata:&#x2F;u01&#x2F;app&#x2F;oracle \  -p 8080:8080 -p 1521:1521 absolutapps">
<meta property="og:image" content="https://i.loli.net/2019/08/06/YNuPfTeKjmhnORW.png">
<meta property="og:image" content="https://i.loli.net/2019/08/06/B1jDuoKHCePpAgd.png">
<meta property="article:published_time" content="2019-09-28T12:03:55.000Z">
<meta property="article:modified_time" content="2020-03-20T17:38:27.722Z">
<meta property="article:author" content="VC">
<meta property="article:tag" content="oracle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2019/08/06/YNuPfTeKjmhnORW.png">

<link rel="canonical" href="https://viggoc.github.io/2019/09/Oracle-note-summary/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Oracle 笔记汇总 | VC' Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">VC' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="default">
    <link itemprop="mainEntityOfPage" href="https://viggoc.github.io/2019/09/Oracle-note-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="VC">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VC' Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Oracle 笔记汇总
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-09-28 20:03:55" itemprop="dateCreated datePublished" datetime="2019-09-28T20:03:55+08:00">2019-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-21 01:38:27" itemprop="dateModified" datetime="2020-03-21T01:38:27+08:00">2020-03-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/09/Oracle-note-summary/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/09/Oracle-note-summary/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h1>
<h2 id="oracle-in-docker"><a class="markdownIt-Anchor" href="#oracle-in-docker"></a> Oracle in Docker</h2>
<p><code>docke search oracle</code>，选择相应的 <a href="https://hub.docker.com/r/absolutapps/oracle-12c-ee" target="_blank" rel="noopener">image</a> 拉取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name oracle \</span><br><span class="line">  --privileged -v $(pwd)&#x2F;oradata:&#x2F;u01&#x2F;app&#x2F;oracle \</span><br><span class="line">  -p 8080:8080 -p 1521:1521 absolutapps&#x2F;oracle-12c-ee</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/padlik/oracle-12c" target="_blank" rel="noopener">镜像说明文档</a> 中 Additional options 的意思是自己基于它的基础包重修 build 的时候可以修改的参数。</p>
<p>PS：在给自用 Ubuntu 安装时非常顺利，在给测试平台的<code>Centos7</code>安装时诡异地出现了<code>docker-entrypoint.sh</code>中一条<code>chown</code>语句卡出运行不了，修改文件中相应的语句后成功安装。</p>
<h2 id="oracle-in-centos"><a class="markdownIt-Anchor" href="#oracle-in-centos"></a> Oracle in Centos</h2>
<p><a href="https://blog.csdn.net/zwl18210851801/article/details/80774980" target="_blank" rel="noopener">静默安装教程</a></p>
<p><a href="https://wiki.centos.org/zh/HowTos/Oracle12onCentos7" target="_blank" rel="noopener">图形化安装教程</a></p>
<h3 id="vi-etcsysctlconf"><a class="markdownIt-Anchor" href="#vi-etcsysctlconf"></a> vi /etc/sysctl.conf</h3>
<p>这里面有很多参数可以优化</p>
<p><strong>内核的 shmall 和 shmmax 参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SHMMAX&#x3D; 配置了最大的内存 segment 的大小 ------&gt;这个设置的比 SGA_MAX_SIZE 大比较好。</span><br><span class="line"></span><br><span class="line">SHMMIN&#x3D; 最小的内存 segment 的大小 </span><br><span class="line"></span><br><span class="line">SHMMNI&#x3D; 整个系统的内存 segment 的总个数</span><br></pre></td></tr></table></figure>
<p>使配置生效<br />
<code>/sbin/sysctl -p</code></p>
<h3 id="swap-不存在"><a class="markdownIt-Anchor" href="#swap-不存在"></a> swap 不存在</h3>
<p>报错，提示swap空间不足</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Checking swap space: 0 MB available, 150 MB required. Failed &lt;&lt;&lt;&lt;</span><br></pre></td></tr></table></figure>
<p>创建 swap 文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1024 count=512k</span><br><span class="line">mkswap /swapfile</span><br><span class="line">swapon /swapfile</span><br></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/a9999/p/6957280.html" target="_blank" rel="noopener">参考</a></p>
<h3 id="配置监听"><a class="markdownIt-Anchor" href="#配置监听"></a> 配置监听</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netca /silent /responsefile /home/database/response/netca.rsp <span class="comment"># 这句话一定要写绝对路径</span></span><br></pre></td></tr></table></figure>
<p>listener.ora 范例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># listener.ora Network Configuration File:&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;12&#x2F;db_1&#x2F;network&#x2F;admin&#x2F;listener.ora</span><br><span class="line"># Generated by Oracle configuration tools.</span><br><span class="line">SID_LIST_LISTENER &#x3D;</span><br><span class="line">  (SID_LIST &#x3D;</span><br><span class="line">    (SID_DESC &#x3D;</span><br><span class="line">      (SID_NAME &#x3D; orcl)</span><br><span class="line">      (ORACLE_HOME &#x3D; &#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;12&#x2F;db_1)</span><br><span class="line">#      (PROGRAM &#x3D; extproc)</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">LISTENER &#x3D;</span><br><span class="line">  (DESCRIPTION_LIST &#x3D;</span><br><span class="line">    (DESCRIPTION &#x3D;</span><br><span class="line">      (ADDRESS &#x3D; (PROTOCOL &#x3D; TCP)(HOST &#x3D; 10.5.16.198)(PORT &#x3D; 1521))</span><br><span class="line">#      (ADDRESS &#x3D; (PROTOCOL &#x3D; IPC)(KEY &#x3D; EXTPROC1521))</span><br><span class="line">    )</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>参考：</p>
<p><a href="http://blog.51cto.com/xjsunjie/1614115" target="_blank" rel="noopener">listener/tnsname</a><br />
<a href="https://docs.oracle.com/cd/B28359_01/network.111/b28317/listener.htm#NETRF008" target="_blank" rel="noopener">listener parameter</a></p>
<p><strong>host 填 localhost 可能出现其他机子连不到的情况</strong></p>
<p>使用 <a href="http://blog.itpub.net/12679300/viewspace-1969620/" target="_blank" rel="noopener">静态监听</a> 方式时，<code>lsnrctl status</code>会看到实例的状态为<code>unknown</code>为正常现象。</p>
<ul>
<li>动态监听：oracle 服务器默认会去绑定<code>1521</code>端口。</li>
<li>静态监听：在监听器中指定数据库信息（路径），由监听器去搜索服务。</li>
</ul>
<h3 id="sqlplus-无法使用-backspace-和-history"><a class="markdownIt-Anchor" href="#sqlplus-无法使用-backspace-和-history"></a> sqlplus 无法使用 backspace 和 history</h3>
<p>Cenots 中使用 sqlplus 无法使用删除和方向键，安装 <a href="https://oracle-base.com/articles/linux/rlwrap" target="_blank" rel="noopener">rlwrap</a> 解决。</p>
<h3 id="系统防火墙配置"><a class="markdownIt-Anchor" href="#系统防火墙配置"></a> 系统防火墙配置</h3>
<p>登录 root 检查防火墙状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># firewall-cmd --get-active-zones</span></span><br><span class="line">public</span><br><span class="line">  interfaces: eth0</span><br></pre></td></tr></table></figure>
<p>打开相关的端口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># firewall-cmd --zone=public --add-port=1521/tcp --add-port=5500/tcp --add-port=5520/tcp --add-port=3938/tcp --permanent</span></span><br><span class="line">success</span><br></pre></td></tr></table></figure>
<p>重新加载生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># firewall-cmd --reload</span></span><br><span class="line">success</span><br></pre></td></tr></table></figure>
<p>查看端口规则</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># firewall-cmd --list-ports</span></span><br><span class="line">1521/tcp 3938/tcp 5500/tcp 5520/tcp</span><br></pre></td></tr></table></figure>
<h3 id="开机自启动配置"><a class="markdownIt-Anchor" href="#开机自启动配置"></a> 开机自启动配置</h3>
<p><a href="https://www.cnblogs.com/meiling12/p/8443823.html" target="_blank" rel="noopener">https://www.cnblogs.com/meiling12/p/8443823.html</a></p>
<ol>
<li>查看ORACLE_HOME是否设置</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo $ORACLE_HOME</span><br><span class="line">&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;product&#x2F;11.2.0&#x2F;dbhome_1</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>执行dbstart 数据库自带启动脚本</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[oracle@<span class="built_in">local</span> ~]$ <span class="built_in">cd</span> <span class="variable">$ORACLE_HOME</span></span><br><span class="line">[oracle@<span class="built_in">local</span> dbhome_1]$ <span class="built_in">cd</span> bin/</span><br><span class="line">[oracle@<span class="built_in">local</span> bin]$ dbstart</span><br><span class="line">ORACLE_HOME_LISTNER is not SET, unable to auto-start Oracle Net Listener Usage: /u01/app/oracle/product/11.2.0/db_1/bin/dbstart ORACLE_HOME</span><br><span class="line">错误提示：ORACLE_HOME_LISTNER 没有设置</span><br><span class="line"></span><br><span class="line">[oracle@<span class="built_in">local</span> bin]$ ll | grep dbs</span><br><span class="line">-rwxr-x---. 1 oracle oinstall 6088 1月 1 2000 dbshut</span><br><span class="line">-rwxr-x---. 1 oracle oinstall 13892 12月 11 16:01 dbstart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 dbstart，将ORACLE_HOME_LISTNER=$1修改成 ORACLE_HOME_LISTNER=$ORACLE_HOME 前提是$ORACLE_HOME环境设置正确</span></span><br><span class="line"></span><br><span class="line">[oracle@<span class="built_in">local</span> bin]$ vi dbstart </span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line">ORACLE_HOME_LISTNER=/u01/app/oracle/product/11.2.0/dbhome_1</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>编辑 <code>/etc/oratab</code> 文件</li>
</ol>
<p>dbca建库时都会自动创建<code>/etc/oratab</code>文件</p>
<p>将 <code>orcl:/u01/app/oracle/product/11.2.0/dbhome_1:N</code><br />
修改成<code>orcl:/u01/app/oracle/product/11.2.0/dbhome_1:Y</code></p>
<ol start="4">
<li>编辑 <code>/etc/rc.d/rc.local</code> 启动文件，添加数据库启动脚本 dbstart</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">local</span> ~]<span class="comment"># vi /etc/rc.d/rc.local</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span><br><span class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span><br><span class="line"><span class="comment"># this script will NOT be run after all other services.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure</span></span><br><span class="line"><span class="comment"># that this script will be executed during boot.</span></span><br><span class="line"></span><br><span class="line">su oracle -lc <span class="string">"/u01/app/oracle/product/11.2.0/dbhome_1/bin/lsnrctl start"</span></span><br><span class="line">su oracle -lc /u01/app/oracle/product/11.2.0/dbhome_1/bin/dbstart</span><br></pre></td></tr></table></figure>
<h1 id="管理"><a class="markdownIt-Anchor" href="#管理"></a> 管理</h1>
<h2 id="用户管理"><a class="markdownIt-Anchor" href="#用户管理"></a> 用户管理</h2>
<p>创建的新用户是没有任何权限的，甚至连登陆的数据库的权限都没有，需要为其指定相应的权限。给一个用户赋权限使用命令<code>grant</code>，回收权限使用命令<code>revoke</code>。</p>
<p>权限分为系统权限和对象权限。</p>
<h3 id="系统权限"><a class="markdownIt-Anchor" href="#系统权限"></a> 系统权限</h3>
<p>用户对数据库的相关权限，connect、resource、dba 等系统权限，如建库、建表、建索引、建存储过程、登陆数据库、修改密码等。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; conn xiaoming/oracle</span><br><span class="line">ERROR:</span><br><span class="line">ORA-01045: user XIAOMING lacks <span class="keyword">CREATE</span> <span class="keyword">SESSION</span> privilege; logon denied</span><br><span class="line">警告：您不再连接到 ORACLE。</span><br><span class="line">SQL&gt; show user</span><br><span class="line">USER 为 ""</span><br><span class="line">SQL&gt; conn system/oracle</span><br><span class="line">已连接。</span><br><span class="line">SQL&gt; grant connect to xiaoming;</span><br><span class="line">授权成功。</span><br><span class="line">SQL&gt; conn xiaoming/oracle</span><br><span class="line">已连接。</span><br></pre></td></tr></table></figure>
<p>注意：准确地说<code>grant connect to xiaoming;</code>中，connect 不是权限，而是角色</p>
<h3 id="对象权限"><a class="markdownIt-Anchor" href="#对象权限"></a> 对象权限</h3>
<p>用户对其他用户的数据对象操作的权限，insert、delete、update、select、all 等对象权限，数据对象有很多，比如表，索引，视图，触发器、存储过程、包等。</p>
<p>执行<code>SELECT * FROM Dba_Object_Size;</code>语句可得到 oracle 数据库对象。</p>
<p>希望 xiaoming 用户可以去查询 scott 的 emp 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> scott.emp <span class="keyword">to</span> xiaoming</span><br></pre></td></tr></table></figure>
<p>希望 xiaoming 用户可以去修改 scott 的 emp 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">update</span> <span class="keyword">on</span> scott.emp <span class="keyword">to</span> xiaoming</span><br></pre></td></tr></table></figure>
<p>希望 xiaoming 用户可以去修改/删除，查询，添加 scott 的 emp 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> scott.emp <span class="keyword">to</span> xiaoming</span><br></pre></td></tr></table></figure>
<p>scott 希望收回 xiaoming 对 emp 表的查询权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> <span class="keyword">select</span> <span class="keyword">on</span> scott.emp <span class="keyword">from</span> xiaoming</span><br></pre></td></tr></table></figure>
<h3 id="权限的传递"><a class="markdownIt-Anchor" href="#权限的传递"></a> 权限的传递</h3>
<p>希望 xiaoming 用户可以去查询 scott 的 emp 表，还希望 xiaoming 可以把这个权限传递给别人。</p>
<p>如果是对象权限，就加入 with grant option</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> emp <span class="keyword">to</span> xiaoming <span class="keyword">with</span> <span class="keyword">grant</span> <span class="keyword">option</span></span><br></pre></td></tr></table></figure>
<p>如果 scott 把 xiaoming 对 emp 表的查询权限回收，那么 xiaohong 的权限被回收。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; conn scott/oracle;</span><br><span class="line">已连接。</span><br><span class="line">SQL&gt; revoke select on emp from xiaoming;</span><br><span class="line">撤销成功。</span><br><span class="line">SQL&gt; conn xiaohong/oracle;</span><br><span class="line">已连接。</span><br><span class="line">SQL&gt; select * from scott.emp;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> scott.emp</span><br><span class="line">*</span><br><span class="line">第 <span class="number">1</span> 行出现错误：</span><br><span class="line">ORA<span class="number">-00942</span>: 表或视图不存在</span><br></pre></td></tr></table></figure>
<p>结果显示：小红受到诛连了。</p>
<ul>
<li>如果是系统权限，就加入 with admin option</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">connect</span> <span class="keyword">to</span> xiaoming <span class="keyword">with</span> <span class="keyword">admin</span> <span class="keyword">option</span></span><br></pre></td></tr></table></figure>
<p>收回这个用户的系统权限时，这个用户已经授予其他用户或角色的此系统权限不会因传播无效</p>
<h3 id="代理用户"><a class="markdownIt-Anchor" href="#代理用户"></a> 代理用户</h3>
<p>proxy users, allowing you to access a schema via a different username/password combination.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CONN / AS SYSDBA</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> test_user <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> test_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> scott <span class="keyword">GRANT</span> <span class="keyword">CONNECT</span> <span class="keyword">THROUGH</span> test_user;</span><br><span class="line"></span><br><span class="line">SQL&gt; CONN test_user[scott]/test_user</span><br><span class="line">SQL&gt; SHOW USER</span><br><span class="line">USER is "SCOTT"</span><br><span class="line">SQL&gt;</span><br></pre></td></tr></table></figure>
<h3 id="特定-schema-的权限"><a class="markdownIt-Anchor" href="#特定-schema-的权限"></a> 特定 schema 的权限</h3>
<p>想要将<code>user1</code>下所有表的查询权限付给<code>user2</code>用户，ORACLE 没有提供这个层级的语句。</p>
<p>方法 1：在 <code>all_tables</code> 中查出所有表后，拷贝输出结果执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'Grant all on '</span>||table_name||<span class="string">'to user2 ;'</span> <span class="keyword">from</span> all_tables </span><br><span class="line"><span class="keyword">where</span> owner = <span class="keyword">upper</span>(user1);</span><br></pre></td></tr></table></figure>
<p>方法 2：存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">procedure</span> grant_selectAll_sql(v_from <span class="keyword">in</span> <span class="built_in">varchar2</span>, v_to <span class="keyword">in</span> <span class="built_in">varchar2</span>) <span class="keyword">is</span></span><br><span class="line">  v_sql <span class="built_in">varchar2</span>(<span class="number">1000</span>);</span><br><span class="line">  cursor v_cur is</span><br><span class="line">    <span class="keyword">select</span> t.* <span class="keyword">from</span> dba_tables t <span class="keyword">where</span> t.OWNER = v_from;</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> v_row <span class="keyword">in</span> v_cur <span class="keyword">loop</span></span><br><span class="line">    v_sql := <span class="string">'grant select on '</span> || v_from || <span class="string">'.'</span> || v_row.table_name || <span class="string">' to '</span> || v_to;</span><br><span class="line">    <span class="keyword">execute</span> <span class="keyword">immediate</span> v_sql;</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure>
<h2 id="表空间管理"><a class="markdownIt-Anchor" href="#表空间管理"></a> 表空间管理</h2>
<h3 id="创建表空间"><a class="markdownIt-Anchor" href="#创建表空间"></a> 创建表空间</h3>
<p>oracle 默认最大数据文件为 32G, 想要创建超过这个大小可以使用。一个 表空间不能混用 <code>datafile</code>和 <code>bigfile</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">bigfile</span> <span class="keyword">tablespace</span> ...</span><br></pre></td></tr></table></figure>
<p>为用户赋予权限，否则会报 <code>ORA-01950</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> userName <span class="keyword">quota</span> [<span class="keyword">unlimited</span>/<span class="number">100</span>M] <span class="keyword">on</span> tablespaceName;</span><br></pre></td></tr></table></figure>
<h3 id="nas-数据存储"><a class="markdownIt-Anchor" href="#nas-数据存储"></a> NAS 数据存储</h3>
<p>oracle 对 NAS 的挂载方式有要求，<a href="http://biancheng.dnbcw.net/oracle/247147.html" target="_blank" rel="noopener">ORACLE 不支持 cifs</a></p>
<p>NFS 挂载命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o rw,<span class="built_in">bg</span>,hard,nointr,rsize=32768,wsize=32768,vers=3,tcp,actimeo=0,timeo=600 192.168.1.2:/ETL /mnt/data</span><br></pre></td></tr></table></figure>
<h2 id="字符集"><a class="markdownIt-Anchor" href="#字符集"></a> 字符集</h2>
<h3 id="server-字符集"><a class="markdownIt-Anchor" href="#server-字符集"></a> server 字符集</h3>
<p>查询 server 字符集</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> V$NLS_PARAMETERS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> userenv(<span class="string">'language'</span>) <span class="keyword">FROm</span> dual;</span><br></pre></td></tr></table></figure>
<h3 id="client-端字符集"><a class="markdownIt-Anchor" href="#client-端字符集"></a> client 端字符集</h3>
<p>在 windows 平台下，就是注册表里面相应 OracleHome 的 NLS_LANG。还可以在 dos 窗口里面自己设置，这样就只影响这个窗口里面的环境变量，比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> nls_lang=AMERICAN_AMERICA.ZHS16GBK</span><br></pre></td></tr></table></figure>
<p>在 unix 平台下，就是环境变量 NLS_LANG。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$NLS_LANG</span></span><br><span class="line">AMERICAN_AMERICA.ZHS16GBK</span><br></pre></td></tr></table></figure>
<p>如果检查的结果发现 server 端与 client 端字符集不一致，请统一修改为同 server 端相同的字符集</p>
<h3 id="dump-文件字符集"><a class="markdownIt-Anchor" href="#dump-文件字符集"></a> dump 文件字符集</h3>
<p>用 oracle 的 exp 工具导出的 dmp 文件也包含了字符集信息，dmp 文件的第 2 和第 3 个字节记录了 dmp 文件的字符集。</p>
<p>如果 dmp 文件不大，比如只有几 M 或几十 M，可以用 UltraEdit 打开 (16 进制方式），看第 2 第 3 个字节的内容，如 0354，然后用以下 SQL 查出它对应的字符集：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select nls_charset_name(to_number(<span class="string">'0354'</span>,<span class="string">'xxxx'</span>)) from dual;</span><br><span class="line">ZHS16GBK</span><br></pre></td></tr></table></figure>
<p><a href="https://blog.csdn.net/dbanote/article/details/9158367" target="_blank" rel="noopener">参考</a></p>
<h2 id="日期"><a class="markdownIt-Anchor" href="#日期"></a> 日期</h2>
<h3 id="oracle-的日期格式"><a class="markdownIt-Anchor" href="#oracle-的日期格式"></a> Oracle 的日期格式</h3>
<p>Oracle 数据缺省的时间格式数据的显示形式，与所使用的字符集有关。一般显示年月日，而不显示时分秒。</p>
<p>例如：</p>
<ul>
<li>
<p>使用 us7ascii 字符集（或者是其他的英语字符集）时，缺省的时间格式显示为：28-Jan-2003，</p>
</li>
<li>
<p>使用 zhs16gbk 字符集（或其他中文字符集）时时间格式缺省显示为：2003-1 月-28。</p>
</li>
</ul>
<p>向表中插入数据时，如果不使用转换函数，则时间字段的格式必须遵从会话环境的时间格式，否则不能插入。</p>
<p>查看当前会话的时间格式，可以使用以下的 SQL 语句：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select sysdate from dual;</span><br></pre></td></tr></table></figure>
<h3 id="修改日期格式的方法"><a class="markdownIt-Anchor" href="#修改日期格式的方法"></a> 修改日期格式的方法</h3>
<ol>
<li>在 sql*plus 中修改当前会话的日期格式</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; alter session set nls_date_format = 'yyyy-mm-dd hh24:mi:ss';</span><br></pre></td></tr></table></figure>
<p>将当前会话的时间格式修改为这种格式： 2003-01-28 15:23:38，这种修改方法，只对当前会话有效。</p>
<p>注意，是对<strong>当前会话</strong>，而不是当前的 sql*plus 窗口。即如果你这样修改之后，又使用 connect 命令以其他用户连接到数据库或者是连接到其他的数据库，则这个日期格式就失效了，又恢复到缺省的日期格式。</p>
<ol start="2">
<li>修改注册表（只对 windows 系统）</li>
</ol>
<p>在注册表<code>/hkey_local_machine/software/oracle/home0</code> 主键中增加一个字串 (8i 版本），字串名为 nls_date_format，字串的值为你希望定义的时间格式，如： yyyy-mm-dd hh24:mi:ss ，然后重新启动 sql*plus。</p>
<p>这种修改方法，对 sql*plus 窗口有效，即不论你打开多少个 sql*plus 窗口，缺省的都是这种时间格式。修改服务器端的注册表无效，只有修改客户端的注册表才有效。</p>
<ol start="3">
<li>修改环境变量（Linux）</li>
</ol>
<p>oracle 用户编辑 <code>.bash_profile</code> 下 加入以下内容，重新登录即可生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NLS_DATE_FORMAT=<span class="string">'YYYY-MM-DD HH24:MI:SS'</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>用 sysdba 登录：然后更新 props$这个表里的字段即可</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update props$ set value &#x3D; &#39;YYYY-MM-DD HH24:MI:SS&#39; where parameter &#x3D; &#39;NLS_DATE_FORMAT&#39;;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>sql developer 修改</li>
</ol>
<p>工具-&gt;首选项-&gt;数据库-&gt;NLS-&gt;日期格式：DD-MON-RR 修改为：<code>YYYY-MM-DD HH24:MI:SS</code></p>
<h2 id="统计信息"><a class="markdownIt-Anchor" href="#统计信息"></a> 统计信息</h2>
<p>sql developer 中看到的统计信息并不是实时的，只有使用<code>analysis</code>命令之后才会更新，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ANALYZE TABLE tablename COMPUTE STATISTICS</span><br></pre></td></tr></table></figure>
<h2 id="数据库恢复与迁移"><a class="markdownIt-Anchor" href="#数据库恢复与迁移"></a> 数据库恢复与迁移</h2>
<p>X医院使用的数据库为 <code>10.2.0.5 in winsows</code>，想要在Centos下恢复。</p>
<h3 id="恢复步骤"><a class="markdownIt-Anchor" href="#恢复步骤"></a> 恢复步骤</h3>
<ol>
<li>
<p>安装数据库</p>
</li>
<li>
<p>修改环境变量 <code>ORACLE_SID</code></p>
</li>
<li>
<p>nomout 启动，恢复 pfile 文件，并修改 pfile 文件中的路径为本地路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rman target &#x2F;</span><br><span class="line"></span><br><span class="line">rman&gt;startup nomount</span><br><span class="line"></span><br><span class="line">rman&gt;restore spfile to pfile &#39;$ORACLE_HOME&#x2F;dbs&#x2F;init_$ORACLE_SID.ora&#39; from&#39;&#x2F;backup&#x2F;rman&#x2F;full_09l9esg4_1_1&#39;;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>sql使用 pfile 重启数据库至 nomount 状态，恢复 controlfile，启动到 mount 状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RMAN&gt; restore controlfile from &#39;...&#39;</span><br><span class="line">RMAN&gt; alter database mount;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>检查备份，设置 datafi 路径，restore datebase</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">RMAN&gt; catalog start with &#39;&#x2F;home&#x2F;oracle&#x2F;rmanbackup&#39;;</span><br><span class="line"></span><br><span class="line">RMAN&gt; run&#123;</span><br><span class="line">2&gt; allocate channel c1 type disk;</span><br><span class="line">3&gt; set newname for datafile 1 to &#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;csdb&#x2F;system01.dbf&#39;;</span><br><span class="line">4&gt; set newname for datafile 2 to &#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;csdb&#x2F;sysaux01.dbf&#39;;</span><br><span class="line">5&gt; set newname for datafile 3 to &#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;csdb&#x2F;undotbs1.dbf&#39;;</span><br><span class="line">6&gt; set newname for datafile 4 to &#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;csdb&#x2F;users01.dbf&#39;;</span><br><span class="line">7&gt; set newname for datafile 5 to &#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;csdb&#x2F;example01.dbf&#39;;</span><br><span class="line">8&gt; set newname for datafile 6 to &#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;csdb&#x2F;undotbs2.dbf&#39;;</span><br><span class="line">9&gt; set newname for datafile 7 to &#39;&#x2F;u01&#x2F;app&#x2F;oracle&#x2F;oradata&#x2F;csdb&#x2F;testtbs01.dbf&#39;;</span><br><span class="line">10&gt; restore database;</span><br><span class="line">11&gt; switch datafile all;</span><br><span class="line">12&gt; release channel c1;</span><br><span class="line">13&gt; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>recover datafilebase</p>
</li>
</ol>
<h3 id="尝试历程"><a class="markdownIt-Anchor" href="#尝试历程"></a> 尝试历程</h3>
<p>备份恢复的时候尽量选择相同的数据库版本，即使相同大版本不同小版本（补丁）也有可能出现各种奇怪的错误无法恢复数据。</p>
<ul>
<li>12c 失败</li>
<li>10.2.0.1 catalog start with 失败</li>
<li>10.2.0.3 restore database 失败</li>
<li>10.2.0.5 restore database 成功，recover database 失败</li>
</ul>
<h3 id="跨平台问题"><a class="markdownIt-Anchor" href="#跨平台问题"></a> 跨平台问题</h3>
<blockquote>
<p>The Cross-platform redo application is only supported for physical standby but not for general media recovery which is involved while duplicating database using RMAN.</p>
</blockquote>
<p>Windows 与 Linux 平台的 Oracle 日志系统不同，无法平台进行恢复，因此想要跨平台恢复存在如下方式：</p>
<ol>
<li>
<p>冷备份：即停机备份</p>
</li>
<li>
<p>热备份时备份 <code>standby controlfile</code> <a href="https://oraclefreak.wordpress.com/rman-backuprestore-from-windows-to-linux/" target="_blank" rel="noopener">（参考）</a></p>
<p>Let’s modify the RMAN script in windows to backup standby controlfile instead of a normal controlfile.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">run</span><br><span class="line">&#123;</span><br><span class="line">allocate channel c1 device type disk;</span><br><span class="line">allocate channel c2 device type disk;</span><br><span class="line">backup as compressed backupset database filesperset 1 format &#39;c:\backup\datafile_%U&#39;;</span><br><span class="line">sql &quot;alter database create standby controlfile as &#39;&#39;c:\backup\control_stby.bak&#39;&#39;&quot;;</span><br><span class="line">release channel c1;</span><br><span class="line">release channel c2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Make a few switch log in windows.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; alter system switch logfile;</span><br><span class="line"></span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改配置跳过一致性检查（本次恢复最终使用此方法）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter system set “_allow_resetlogs_corruption”&#x3D;true scope&#x3D;spfile;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>BBED 可以直接修改文件头，骗过一致性检查 <a href="https://dba.stackexchange.com/questions/163074/duplicate-oracle-database-from-windows-to-linux" target="_blank" rel="noopener">（参考）</a></p>
</li>
</ol>
<h1 id="sql"><a class="markdownIt-Anchor" href="#sql"></a> SQL</h1>
<h2 id="in-vs-exists"><a class="markdownIt-Anchor" href="#in-vs-exists"></a> in vs exists</h2>
<p>in 和 exists 主要是造成了驱动顺序的改变（这是性能变化的关键），如果是 exists，那么以外层表为驱动表，先被访问，如果是 IN，那么先执行子查询，所以我们会以驱动表的快速返回为目标。因此 in 适用于内表小，exists 适用于外表小。</p>
<h2 id="not-in-vs-not-exists"><a class="markdownIt-Anchor" href="#not-in-vs-not-exists"></a> not in vs not exists</h2>
<p>对于 <code>not in</code>如果子查询中返回的任意一条记录含有空值，则查询将不返回任何记录。</p>
<p><a href="https://blog.csdn.net/baidu_37107022/article/details/77278381" target="_blank" rel="noopener">性能对比</a></p>
<h2 id="联表更新"><a class="markdownIt-Anchor" href="#联表更新"></a> 联表更新</h2>
<p>写法 1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> test1 t1</span><br><span class="line">    <span class="keyword">set</span> t1.object_name = (<span class="keyword">select</span> t2.object_name</span><br><span class="line">        <span class="keyword">from</span> test2 t2</span><br><span class="line">    <span class="keyword">where</span> t1.object_id = t2.object_id)</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> test2 t3 </span><br><span class="line">    <span class="keyword">where</span> t3.object_id = t1.object_id);</span><br></pre></td></tr></table></figure>
<p>写法 2 (inline view 更新法）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> (<span class="keyword">select</span> t1.object_name, t2.object_name new_object_name</span><br><span class="line">    <span class="keyword">from</span> test1 t1, test2 t2</span><br><span class="line">    <span class="keyword">where</span> t1.object_id = t2.object_id)</span><br><span class="line"><span class="keyword">set</span> object_name = new_object_name;</span><br></pre></td></tr></table></figure>
<p>写法 3 (merge 法）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">merge</span> <span class="keyword">into</span> test1 t1</span><br><span class="line"><span class="keyword">using</span> test2 t2</span><br><span class="line"><span class="keyword">on</span> (t1.object_id = t2.object_id)</span><br><span class="line"><span class="keyword">when</span> <span class="keyword">matched</span> <span class="keyword">then</span></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">set</span> t1.object_name = t2.object_name;</span><br></pre></td></tr></table></figure>
<p><strong>这种写法不能对<code>on</code>条件中用到的字段进行更新</strong>。</p>
<p>写法 2-3 更优，方法 1 会进行两次子查询</p>
<p>写法 4 （快速游标法）: 没用过</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>建议</th>
</tr>
</thead>
<tbody>
<tr>
<td>标准 update 语法</td>
<td>单表更新或较简单的语句采用使用此方案更优。</td>
</tr>
<tr>
<td>inline view 更新法</td>
<td>两表关联且被更新表通过关联表主键关联的，采用此方案更优。</td>
</tr>
<tr>
<td>merge 更新法</td>
<td>两表关联且被更新表不是通过关联表主键关联的，采用此方案更优。</td>
</tr>
<tr>
<td>快速游标更新法</td>
<td>多表关联且逻辑复杂的，采用此方案更优。</td>
</tr>
</tbody>
</table>
<h2 id="联表删除"><a class="markdownIt-Anchor" href="#联表删除"></a> 联表删除</h2>
<p>创建表 A</p>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>1</td>
</tr>
<tr>
<td>b</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>创建表 B</p>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>1</td>
</tr>
<tr>
<td>c</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>从表 A 中删除，与 B 中 key，value 都相等的数据。</p>
<p>方法 1: 无条件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> A</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> B <span class="keyword">where</span> A.key = B.key </span><br><span class="line">        <span class="keyword">and</span> A.value = B.value</span><br><span class="line">)</span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> A</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">rowid</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> a.rowid <span class="keyword">from</span> B <span class="keyword">where</span> A.key = B.key </span><br><span class="line">        <span class="keyword">and</span> A.value = B.value);</span><br></pre></td></tr></table></figure>
<p>方法 2：要求其中一个表要有主键</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span> * <span class="keyword">from</span> B,A </span><br><span class="line"><span class="keyword">where</span> A.key = B.key</span><br><span class="line">    <span class="keyword">and</span> A.value = B.value);</span><br></pre></td></tr></table></figure>
<p>经测试，删除结果为：当两个表都有主键时删除位置靠前的表的数据，当其中一个表没有主键时删除没有主键的表的数据。</p>
<h1 id="优化"><a class="markdownIt-Anchor" href="#优化"></a> 优化</h1>
<h2 id="oracle-数据库性能优化与运维最佳实践"><a class="markdownIt-Anchor" href="#oracle-数据库性能优化与运维最佳实践"></a> Oracle 数据库性能优化与运维最佳实践</h2>
<h3 id="指导思想"><a class="markdownIt-Anchor" href="#指导思想"></a> 指导思想</h3>
<p>自上而下优化以下内容：</p>
<ol>
<li>优化应用程序代码之前先优化设计</li>
<li>优化实例之前先优化代码<br />
对可以带来最大潜在好处的方面进行优化并确定：</li>
<li>最长的等待</li>
<li>最慢的 SQL<br />
达到目标时停止优化</li>
</ol>
<h3 id="优化过程"><a class="markdownIt-Anchor" href="#优化过程"></a> 优化过程</h3>
<ol>
<li>定义问题并陈述目标</li>
<li>收集当前性能统计信息</li>
<li>考虑一些常见的性能错误</li>
<li>制定适用解决方案</li>
<li>事实并度量更改</li>
<li>是否达到目标？完成：转到步骤 3</li>
</ol>
<h3 id="实践方法"><a class="markdownIt-Anchor" href="#实践方法"></a> 实践方法</h3>
<ul>
<li>监视和诊断——<a href="https://sq.163yun.com/blog/article/177908307918032896" target="_blank" rel="noopener">使用 AWR 报告分析 Oracle 数据库性能</a></li>
<li>SQL 优化</li>
<li>实例优化</li>
</ul>
<h2 id="select-tuning"><a class="markdownIt-Anchor" href="#select-tuning"></a> Select Tuning</h2>
<p><em>事实上简单查询时 CBO (Cost-Based Optimization) 已经能够完成优化工作，但在写复杂的嵌套查询是仍需要注意。</em></p>
<h3 id="from-查询顺序-小表在后"><a class="markdownIt-Anchor" href="#from-查询顺序-小表在后"></a> from 查询顺序 小表在后</h3>
<p>ORACLE 的解析器按照<strong>从右到左</strong>的顺序处理 FROM 子句中的表名，因此 FROM 子句中写在最后的表（驱动表 driving table) 将被最先处理。在 FROM 子句中包含多个表的情况下，你必须选择记录条数最少的表作为基础表。当 ORACLE 处理多个表时，会运用排序及合并的方式连接它们。首先，扫描第一个表 (FROM 子句中最后的那个表）并对记录进行排序，然后扫描第二个表 (FROM 子句中最后第二个表）, 最后将所有从第二个表中检索出的记录与第一个表中合适记录进行合并。</p>
<p>如：TAB1 有两千万条，TAB2 中有 1 条</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> TAB1, TAB2; <span class="comment">--20s</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> TAB2, TAB1; <span class="comment">--40s</span></span><br></pre></td></tr></table></figure>
<p>如果有 3 个以上的表连接查询，那就需要选择交叉表 (intersection table) 作为基础表，交叉表是指那个被其他表所引用的表。</p>
<p>例如：EMP 表描述了 LOCATION 表和 CATEGORY 表的交集。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> LOCATION L ,</span><br><span class="line">       <span class="keyword">CATEGORY</span> C,</span><br><span class="line">       EMP E</span><br><span class="line"><span class="keyword">WHERE</span> E.EMP_NO <span class="keyword">BETWEEN</span> <span class="number">1000</span> <span class="keyword">AND</span> <span class="number">2000</span></span><br><span class="line"><span class="keyword">AND</span> E.CAT_NO = C.CAT_NO</span><br><span class="line"><span class="keyword">AND</span> E.LOCN = L.LOCN</span><br><span class="line"><span class="comment">-- 将比下列 SQL 更有效率</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> EMP E ,</span><br><span class="line">LOCATION L ,</span><br><span class="line">       <span class="keyword">CATEGORY</span> C</span><br><span class="line"><span class="keyword">WHERE</span>   E.CAT_NO = C.CAT_NO</span><br><span class="line"><span class="keyword">AND</span> E.LOCN = L.LOCN</span><br><span class="line"><span class="keyword">AND</span> E.EMP_NO <span class="keyword">BETWEEN</span> <span class="number">1000</span> <span class="keyword">AND</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>
<h3 id="where-查询顺序"><a class="markdownIt-Anchor" href="#where-查询顺序"></a> where 查询顺序</h3>
<p>ORACLE 采用<strong>自下而上</strong>的顺序解析 WHERE 子句，根据这个原理，</p>
<ul>
<li>表之间的连接必须写在其他 WHERE 条件之前，</li>
<li>可以过滤掉最大数量记录的条件必须写在 WHERE 子句的末尾。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- （低效，执行时间 156.3 秒）</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> EMP E</span><br><span class="line"><span class="keyword">WHERE</span>   SAL &gt;<span class="number">50000</span></span><br><span class="line"><span class="keyword">AND</span>     JOB = ‘MANAGER’</span><br><span class="line"><span class="keyword">AND</span>     <span class="number">25</span> &lt; (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> EMP</span><br><span class="line"><span class="keyword">WHERE</span> MGR=E.EMPNO);</span><br><span class="line"><span class="comment">-- （高效，执行时间 10.6 秒）</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> EMP E</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">25</span> &lt; (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> EMP</span><br><span class="line">              <span class="keyword">WHERE</span> MGR=E.EMPNO)</span><br><span class="line"><span class="keyword">AND</span>     SAL &gt;<span class="number">50000</span></span><br><span class="line"><span class="keyword">AND</span>     JOB = ‘MANAGER’;</span><br></pre></td></tr></table></figure>
<h3 id="避免使用"><a class="markdownIt-Anchor" href="#避免使用"></a> 避免使用 <code>*</code></h3>
<p>ORACLE 在解析的过程中，会将’*’ 依次转换成所有的列名，这个工作是通过查询数据字典完成的，这意味着将耗费更多的时间。</p>
<p><em>在 OLAP 场景下作用不大</em> ，语句运行的时间远大于解析时间 。</p>
<h3 id="减少访问次数"><a class="markdownIt-Anchor" href="#减少访问次数"></a> 减少访问次数</h3>
<p><em>未实践</em></p>
<p>当执行每条 SQL 语句时，ORACLE 在内部执行了许多工作：解析 SQL 语句，估算索引的利用率，绑定变量 , 读数据块等等。由此可见，减少访问数据库的次数 , 就能实际上减少 ORACLE 的工作量。</p>
<p>在 SQL*Plus , SQL*Forms 和 Pro*C 中重新设置 ARRAYSIZE 参数，可以增加每次数据库访问的检索数据量 , 建议值为 200.</p>
<h3 id="使用-decode-函数来减少处理时间"><a class="markdownIt-Anchor" href="#使用-decode-函数来减少处理时间"></a> 使用 DECODE 函数来减少处理时间</h3>
<p>使用 DECODE 函数可以避免重复扫描相同记录或重复连接相同的表。</p>
<h2 id="insert-tuning"><a class="markdownIt-Anchor" href="#insert-tuning"></a> Insert Tuning</h2>
<ul>
<li>停用/删除索引和约束，载入数据后重建</li>
</ul>
<blockquote>
<p>a - Disable/drop indexes and constraints - It’s far faster to rebuild indexes after the data load, all at-once. Also indexes will rebuild cleaner, and with less I/O if they reside in a tablespace with a large block size.</p>
</blockquote>
<ul>
<li>管理并行插入时的段头争用</li>
</ul>
<blockquote>
<p>b - Manage segment header contention for parallel inserts - Make sure to define <a href="https://www.eygle.com/archives/2011/11/freelistsfreeli.html" target="_blank" rel="noopener">multiple freelist (or freelist groups)</a> to remove contention for the table header. Multiple freelists add additional segment header blocks, removing the bottleneck.  You can also use Automatic Segment Space Management (bitmap freelists) to support parallel DML, but ASSM has some limitations.</p>
</blockquote>
<ul>
<li>使用 hint 并行加载</li>
</ul>
<blockquote>
<p>c - Parallelize the load - You can invoke parallel DML (i.e. using the PARALLEL and APPEND hint) to have multiple inserts into the same table. For this INSERT optimization, make sure to define multiple freelists and use the SQL “APPEND” option.  Mark Bobak notes that if you submit parallel jobs to insert against the table at the same time, using the APPEND hint may cause serialization, removing the benefit of parallel jobstreams.</p>
</blockquote>
<ul>
<li>使用 <code>append</code> 使表顺序写入硬盘</li>
</ul>
<blockquote>
<p>d - APPEND into tables - By using the APPEND hint, you ensure that Oracle always grabs “fresh” data blocks by raising the high-water-mark for the table. If you are doing parallel insert DML, the Append mode is the default and you don’t need to specify an APPEND hint.  Mark Bobak notes “Also, if you’re going w/ APPEND, consider putting the table into <strong>NOLOGGING</strong> mode, which will allow Oracle to avoid almost all redo logging.”</p>
<p><code>insert /*+ append */ into customer values ('hello',';there');</code></p>
</blockquote>
<ul>
<li>使用更大的 blocksize</li>
</ul>
<blockquote>
<p>e - Use a large blocksize - By defining large (i.e. 32k) blocksizes for the target table, you reduce I/O because more rows fit onto a block before a “block full” condition (as set by PCTFREE) unlinks the block from the freelist.</p>
<p>See benchmark test of blocksize and inserts <a href="http://www.dba-oracle.com/t_insert_tuning.htm#blocksize_insert" target="_blank" rel="noopener">here</a></p>
<p>See general benefits of multiple blocksizes <a href="http://www.dba-oracle.com/t_multiple_blocksizes_summary.htm" target="_blank" rel="noopener">here</a></p>
</blockquote>
<ul>
<li>使用 NOLOGGING 参数</li>
</ul>
<blockquote>
<p>f - Use NOLOGGING</p>
</blockquote>
<ul>
<li>使用告诉的硬盘</li>
</ul>
<blockquote>
<p>g- RAM disk - You can use high-speed solid-state disk (RAM-SAN) to make Oracle inserts run up to 300x faster than platter disk.</p>
</blockquote>
<p><a href="https://www.akadia.com/services/ora_insert_append.html" target="_blank" rel="noopener">操作顺序</a></p>
<ul>
<li>Mark indexes unuasble</li>
<li>Disable primary key</li>
<li>Alter table nologging</li>
<li>Do an insert /*+ append */ into table (select …)</li>
<li>Enable primary key</li>
<li>Rebuild indexes nologging</li>
</ul>
<p><a href="http://www.dba-oracle.com/t_insert_tuning.htm" target="_blank" rel="noopener">参考</a></p>
<h2 id="update-tuning"><a class="markdownIt-Anchor" href="#update-tuning"></a> Update Tuning</h2>
<h3 id="子查询-update-过慢问题"><a class="markdownIt-Anchor" href="#子查询-update-过慢问题"></a> 子查询 update 过慢问题</h3>
<p>一下两条语句功能完全相同，但在执行效率有巨大差异</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> scott.mytables a</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">    a.tablespace_name = (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            b.tablespace_name</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            scott.all_tables b</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            a.owner = b.owner</span><br><span class="line">            <span class="keyword">AND</span> a.table_name = b.table_name</span><br><span class="line">    );<span class="comment">--3.93s</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> scott.mytables a </span><br><span class="line"><span class="keyword">USING</span> scott.all_tables b </span><br><span class="line"><span class="keyword">ON</span> ( a.owner = b.owner <span class="keyword">AND</span> a.table_name = b.table_name )</span><br><span class="line"><span class="keyword">WHEN</span> <span class="keyword">MATCHED</span> <span class="keyword">THEN</span> </span><br><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">SET</span> a.tablespace_name = b.tablespace_name;</span><br></pre></td></tr></table></figure>
<p>适用 autotrace 跟踪实际运行 cost（用 10g 貌似跑不了，执行计划的估计有误），结果如下<br />
<img src="https://i.loli.net/2019/08/06/YNuPfTeKjmhnORW.png" alt="" /></p>
<p><img src="https://i.loli.net/2019/08/06/B1jDuoKHCePpAgd.png" alt="" /></p>
<p>使用子查询时以外表为条件，循环对内表进行查询（Nested Loop Join），join 的 cost 很高</p>
<p>使用 merg 语句时，使用了 hash join 进行了优化，join 几乎没有什么成本（这一点 oracle 优化得不错，mysql 都还没实现 hash join）</p>
<p><a href="https://logicalread.com/oracle-explain-plans-driving-tables-and-table-joins-h01/#.XUkjvN9fgUE" target="_blank" rel="noopener">Nested Loop Join/Merge Join/Hash Join</a></p>
<h2 id="数据库参数调优"><a class="markdownIt-Anchor" href="#数据库参数调优"></a> 数据库参数调优</h2>
<p><a href="https://blog.csdn.net/orcldb/article/details/8078190" target="_blank" rel="noopener">sga/pga 分配</a></p>
<h2 id="use-subqueries-to-count-distinct-50x-faster"><a class="markdownIt-Anchor" href="#use-subqueries-to-count-distinct-50x-faster"></a> Use Subqueries to Count Distinct 50X Faster</h2>
<p><a href="https://www.periscopedata.com/blog/use-subqueries-to-count-distinct-50x-faster" target="_blank" rel="noopener">https://www.periscopedata.com/blog/use-subqueries-to-count-distinct-50x-faster</a></p>
<h2 id="io-优化"><a class="markdownIt-Anchor" href="#io-优化"></a> IO 优化</h2>
<p>通过将数据分布存储至多个硬盘，可以通过并行 IO 提升效率。在建立 datafile 时就要合理分配</p>
<p><a href="http://www.dba-oracle.com/art_disk_io.htm" target="_blank" rel="noopener">Turning the Tables on Disk I/O </a></p>
<p><a href="https://asktom.oracle.com/pls/apex/f?p=100:11:0::::P11_QUESTION_ID:7116328455352" target="_blank" rel="noopener">spread a table into multiple disk</a></p>
<h1 id="错误处理"><a class="markdownIt-Anchor" href="#错误处理"></a> 错误处理</h1>
<h2 id="ora-00257"><a class="markdownIt-Anchor" href="#ora-00257"></a> ORA-00257</h2>
<p>ORA-00257: archiver error. Connect internal only, until freed.</p>
<p>ORACLE 默认的日志归档路径为闪回恢复区（$ORACLE_BASE/fast_recovery_area）。对于这个路径，Oracle 有一个限制，就是默认只有 4G 的空间，而且不只是归档日志的默认路径，也是备份文件和闪回日志的默认地址，这样的话归档日志锁使用的空间就达不到 4G，在没有设置好这个路径大小的情况下，很多系统都遇到过归档日志满而无法归档导致数据库夯住的问题。</p>
<h3 id="分析"><a class="markdownIt-Anchor" href="#分析"></a> 分析</h3>
<ol>
<li>查看归档日志路径</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt;  archive log list;</span><br><span class="line">数据库日志模式            存档模式</span><br><span class="line">自动存档             启用</span><br><span class="line">存档终点            USE_DB_RECOVERY_FILE_DEST</span><br><span class="line">最早的联机日志序列     6827</span><br><span class="line">下一个存档日志序列   6827</span><br><span class="line">当前日志序列           6829</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>查看 DB_RECOVERY_FILE_DEST 路径</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; show parameter db_recovery;</span><br><span class="line"></span><br><span class="line">NAME                                 TYPE        VALUE</span><br><span class="line">------------------------------------ ----------- ------------------------------</span><br><span class="line">db_recovery_file_dest                string      E:\oracle\product\10.2.0&#x2F;flash</span><br><span class="line">                                                 _recovery_area</span><br><span class="line">db_recovery_file_dest_size           big integer 2G</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>查看闪回恢复区的使用情况</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; select * from v$flash_recovery_area_usage;</span><br><span class="line"></span><br><span class="line">FILE_TYPE    PERCENT_SPACE_USED PERCENT_SPACE_RECLAIMABLE NUMBER_OF_FILES</span><br><span class="line">------------ ------------------ ------------------------- ---------------</span><br><span class="line">CONTROLFILE                   0                         0               0</span><br><span class="line">ONLINELOG                     0                         0               0</span><br><span class="line">ARCHIVELOG                98.38                         0              43</span><br><span class="line">BACKUPPIECE                 .69                       .35               2</span><br><span class="line">IMAGECOPY                     0                         0               0</span><br><span class="line">FLASHBACKLOG                  0                         0               0</span><br></pre></td></tr></table></figure>
<p>确定了确实是因为闪回恢复区的空间不足造成的问题</p>
<h3 id="解决方法"><a class="markdownIt-Anchor" href="#解决方法"></a> 解决方法</h3>
<ol>
<li>手动扩容</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter system set db_recovery_file_dest_size&#x3D;10G;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>修改日志路径</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--修改 log_archive_dest_1 值来重新制定路径</span><br><span class="line">SQL&gt; alter system set log_archive_dest_1&#x3D;&#39;location&#x3D;&#x2F;u01&#x2F;oracle&#x2F;archive&#39;;</span><br><span class="line"> </span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure>
<p>重启</p>
<h2 id="ora-22858-数据类型的变更无效"><a class="markdownIt-Anchor" href="#ora-22858-数据类型的变更无效"></a> ORA-22858: 数据类型的变更无效</h2>
<p>原因：Oracle 不允许将字段类型修改为：object、REF、nested table、varchar、clob、blob</p>
<p>解决方法：1. 修改该字段的名称。2. 新建一个正确的字段。3. 将数据同步的到新字段。4. 删除错误字段。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/oracle/" rel="tag"># oracle</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/06/linux-env/" rel="prev" title="Linux 环境变量">
      <i class="fa fa-chevron-left"></i> Linux 环境变量
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/10/git_cheat_sheet/" rel="next" title="Git 操作备忘">
      Git 操作备忘 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#安装"><span class="nav-number">1.</span> <span class="nav-text"> 安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#oracle-in-docker"><span class="nav-number">1.1.</span> <span class="nav-text"> Oracle in Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#oracle-in-centos"><span class="nav-number">1.2.</span> <span class="nav-text"> Oracle in Centos</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vi-etcsysctlconf"><span class="nav-number">1.2.1.</span> <span class="nav-text"> vi &#x2F;etc&#x2F;sysctl.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#swap-不存在"><span class="nav-number">1.2.2.</span> <span class="nav-text"> swap 不存在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置监听"><span class="nav-number">1.2.3.</span> <span class="nav-text"> 配置监听</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sqlplus-无法使用-backspace-和-history"><span class="nav-number">1.2.4.</span> <span class="nav-text"> sqlplus 无法使用 backspace 和 history</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统防火墙配置"><span class="nav-number">1.2.5.</span> <span class="nav-text"> 系统防火墙配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开机自启动配置"><span class="nav-number">1.2.6.</span> <span class="nav-text"> 开机自启动配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#管理"><span class="nav-number">2.</span> <span class="nav-text"> 管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#用户管理"><span class="nav-number">2.1.</span> <span class="nav-text"> 用户管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统权限"><span class="nav-number">2.1.1.</span> <span class="nav-text"> 系统权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对象权限"><span class="nav-number">2.1.2.</span> <span class="nav-text"> 对象权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#权限的传递"><span class="nav-number">2.1.3.</span> <span class="nav-text"> 权限的传递</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代理用户"><span class="nav-number">2.1.4.</span> <span class="nav-text"> 代理用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#特定-schema-的权限"><span class="nav-number">2.1.5.</span> <span class="nav-text"> 特定 schema 的权限</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表空间管理"><span class="nav-number">2.2.</span> <span class="nav-text"> 表空间管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建表空间"><span class="nav-number">2.2.1.</span> <span class="nav-text"> 创建表空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nas-数据存储"><span class="nav-number">2.2.2.</span> <span class="nav-text"> NAS 数据存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#字符集"><span class="nav-number">2.3.</span> <span class="nav-text"> 字符集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#server-字符集"><span class="nav-number">2.3.1.</span> <span class="nav-text"> server 字符集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#client-端字符集"><span class="nav-number">2.3.2.</span> <span class="nav-text"> client 端字符集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dump-文件字符集"><span class="nav-number">2.3.3.</span> <span class="nav-text"> dump 文件字符集</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日期"><span class="nav-number">2.4.</span> <span class="nav-text"> 日期</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#oracle-的日期格式"><span class="nav-number">2.4.1.</span> <span class="nav-text"> Oracle 的日期格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改日期格式的方法"><span class="nav-number">2.4.2.</span> <span class="nav-text"> 修改日期格式的方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#统计信息"><span class="nav-number">2.5.</span> <span class="nav-text"> 统计信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库恢复与迁移"><span class="nav-number">2.6.</span> <span class="nav-text"> 数据库恢复与迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#恢复步骤"><span class="nav-number">2.6.1.</span> <span class="nav-text"> 恢复步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#尝试历程"><span class="nav-number">2.6.2.</span> <span class="nav-text"> 尝试历程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨平台问题"><span class="nav-number">2.6.3.</span> <span class="nav-text"> 跨平台问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#sql"><span class="nav-number">3.</span> <span class="nav-text"> SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#in-vs-exists"><span class="nav-number">3.1.</span> <span class="nav-text"> in vs exists</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#not-in-vs-not-exists"><span class="nav-number">3.2.</span> <span class="nav-text"> not in vs not exists</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#联表更新"><span class="nav-number">3.3.</span> <span class="nav-text"> 联表更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#联表删除"><span class="nav-number">3.4.</span> <span class="nav-text"> 联表删除</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#优化"><span class="nav-number">4.</span> <span class="nav-text"> 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#oracle-数据库性能优化与运维最佳实践"><span class="nav-number">4.1.</span> <span class="nav-text"> Oracle 数据库性能优化与运维最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#指导思想"><span class="nav-number">4.1.1.</span> <span class="nav-text"> 指导思想</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化过程"><span class="nav-number">4.1.2.</span> <span class="nav-text"> 优化过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实践方法"><span class="nav-number">4.1.3.</span> <span class="nav-text"> 实践方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#select-tuning"><span class="nav-number">4.2.</span> <span class="nav-text"> Select Tuning</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#from-查询顺序-小表在后"><span class="nav-number">4.2.1.</span> <span class="nav-text"> from 查询顺序 小表在后</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-查询顺序"><span class="nav-number">4.2.2.</span> <span class="nav-text"> where 查询顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#避免使用"><span class="nav-number">4.2.3.</span> <span class="nav-text"> 避免使用 *</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#减少访问次数"><span class="nav-number">4.2.4.</span> <span class="nav-text"> 减少访问次数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-decode-函数来减少处理时间"><span class="nav-number">4.2.5.</span> <span class="nav-text"> 使用 DECODE 函数来减少处理时间</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#insert-tuning"><span class="nav-number">4.3.</span> <span class="nav-text"> Insert Tuning</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#update-tuning"><span class="nav-number">4.4.</span> <span class="nav-text"> Update Tuning</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#子查询-update-过慢问题"><span class="nav-number">4.4.1.</span> <span class="nav-text"> 子查询 update 过慢问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库参数调优"><span class="nav-number">4.5.</span> <span class="nav-text"> 数据库参数调优</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#use-subqueries-to-count-distinct-50x-faster"><span class="nav-number">4.6.</span> <span class="nav-text"> Use Subqueries to Count Distinct 50X Faster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#io-优化"><span class="nav-number">4.7.</span> <span class="nav-text"> IO 优化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#错误处理"><span class="nav-number">5.</span> <span class="nav-text"> 错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ora-00257"><span class="nav-number">5.1.</span> <span class="nav-text"> ORA-00257</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分析"><span class="nav-number">5.1.1.</span> <span class="nav-text"> 分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方法"><span class="nav-number">5.1.2.</span> <span class="nav-text"> 解决方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ora-22858-数据类型的变更无效"><span class="nav-number">5.2.</span> <span class="nav-text"> ORA-22858: 数据类型的变更无效</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">VC</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">VC</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://mist.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el: '#valine-comments',
      verify: false,
      notify: false,
      appId: 'N1lbWM73Gja5VWPf0YfwSM0w-9Nh9j0Va',
      appKey: '7NPQ5VnrCiGVu742uhUiL3kO',
      placeholder: "Just go go",
      avatar: 'mm',
      meta: guest,
      pageSize: '10' || 10,
      visitor: false,
      lang: 'en' || 'zh-cn',
      path: location.pathname,
      recordIP: false,
      serverURLs: ''
    });
  }, window.Valine);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
